name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
      fail-fast: false  # Don't cancel other jobs if one fails

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip xvfb
        
    - name: Install Chrome
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: Install ChromeDriver
      run: |
        CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f3 | cut -d '.' -f1)
        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
        wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
        sudo unzip /tmp/chromedriver.zip chromedriver -d /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install selenium
    
    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=legacy,logs,data,__pycache__,.git
        # Treat all errors as warnings for now (can be made stricter later)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics --exclude=legacy,logs,data,__pycache__,.git
      continue-on-error: true
    
    - name: Check code formatting with black (non-blocking)
      run: |
        black --check --diff --exclude="/(legacy|logs|data|__pycache__|\.git)/" . || echo "⚠️ Code formatting issues found, but not blocking CI"
      continue-on-error: true
    
    - name: Check import sorting with isort (non-blocking)
      run: |
        isort --check-only --diff --skip-glob="legacy/*,logs/*,data/*,__pycache__/*" . || echo "⚠️ Import sorting issues found, but not blocking CI"
      continue-on-error: true
    
    - name: Type checking with mypy (non-blocking)
      run: |
        mypy . --ignore-missing-imports --exclude="/(legacy|logs|data|__pycache__|\.git)/" || echo "⚠️ Type checking issues found, but not blocking CI"
      continue-on-error: true
    
    - name: Test core imports
      run: |
        python -c "import sys; print(f'✅ Python {sys.version}')"
        python -c "from universal_selenium_scraper import UniversalSeleniumScraper; print('✅ Universal scraper import successful')"
        python -c "from utils.product_checker import ProductChecker; print('✅ Product checker import successful')"
        python -c "from bot.discord_bot import DiscordBot; print('✅ Discord bot import successful')" || echo "⚠️ Discord bot import failed, but continuing"
      continue-on-error: true
    
    - name: Run tests with pytest
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 3
        pytest tests/ -v --tb=short || echo "⚠️ Some tests failed, but not blocking CI"
      if: matrix.python-version == '3.11'  # Only run full tests on one Python version
      continue-on-error: true